name: Create Release Tag

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Select the source branch (must start with release/)"
        required: true
        type: string
        default: "release/"

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest

    steps:
      - name: Validate source branch
        run: |
          if [[ ! "${{ github.event.inputs.source_branch }}" =~ ^release/ ]]; then
            echo "üö´ Invalid branch. Only branches starting with 'release/' are allowed."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.source_branch }}
          fetch-depth: 0  # need tags for comparison

      - name: Extract version from file
        id: version
        run: |
          VERSION=$(grep -oP '(?<=__version__ = ")[^"]+' apps/version/__init__.py)
          if [ -z "$VERSION" ]; then
            echo "‚ùå Version not found in apps/version/__init__.py"
            exit 1
          fi
          echo "‚úÖ Found version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get latest tag
        id: latest
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "Latest tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Compare versions
        run: |
          CURRENT="${{ steps.version.outputs.version }}"
          LATEST="${{ steps.latest.outputs.latest_tag }}"
          echo "Comparing $CURRENT with $LATEST"

          if [ "$LATEST" = "none" ]; then
            echo "üÜï No existing tags, proceeding to create $CURRENT"
          elif [ "$CURRENT" = "$LATEST" ]; then
            echo "üö´ Version $CURRENT already exists as tag."
            exit 1
          else
            echo "‚úÖ New version detected: $CURRENT (latest was $LATEST)"
          fi

      - name: Create Git tag and release
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üè∑Ô∏è Creating new tag: v$VERSION"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

          echo "üì¶ Creating GitHub release..."
          gh release create "v$VERSION" \
            --title "Release v$VERSION" \
            --notes "Automated release from branch ${{ github.event.inputs.source_branch }}"