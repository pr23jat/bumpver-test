name: Create Release Tag

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest
    environment: dev 

    steps:
      - name: Validate source branch
        run: |
          if [[ ! "${{ github.ref_name }}" =~ ^release/ ]]; then
            echo "üö´ Invalid branch. Only branches starting with 'release/' are allowed."
            exit 1
          fi
          echo "‚úÖ Branch validated: ${{ github.ref_name }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Extract version from file
        id: version
        run: |
          VERSION=$(grep -oP '(?<=__version__ = ")[^"]+' apps/version/__init__.py)
          if [ -z "$VERSION" ]; then
            echo "‚ùå Version not found in apps/version/__init__.py"
            exit 1
          fi
          echo "‚úÖ Found version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get latest tag
        id: latest
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "Latest tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Compare versions
        run: |
          CURRENT="${{ steps.version.outputs.version }}"
          LATEST="${{ steps.latest.outputs.latest_tag }}"
          echo "Comparing $CURRENT with $LATEST"

          if [ "$LATEST" = "none" ]; then
            echo "üÜï No existing tags, proceeding to create $CURRENT"
          elif [ "$CURRENT" = "$LATEST" ]; then
            echo "üö´ Version $CURRENT already exists as tag."
            exit 1
          else
            echo "‚úÖ New version detected: $CURRENT (latest was $LATEST)"
          fi

      - name: Verify GH_ACTION_PAT (safe check)
        run: |
          if [ -z "${{ secrets.GH_ACTION_PAT }}" ]; then
            echo "‚ùå GH_ACTION_PAT is not available"
            exit 1
          else
            echo "‚úÖ GH_ACTION_PAT is available (not showing value)"
            gh auth status || gh auth login --with-token <<< "${{ secrets.GH_ACTION_PAT }}"
          fi
        env:
          GH_ACTION_PAT: ${{ secrets.GH_ACTION_PAT }}

      - name: Create Git tag and release
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.latest.outputs.latest_tag }}
          GITHUB_TOKEN: ${{ secrets.GH_ACTION_PAT }}
        run: |
          echo "üè∑Ô∏è Creating new tag: $VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "$VERSION"
          git push origin "$VERSION"

          echo "üì¶ Determining previous tag..."
          PREVIOUS_TAG="${LATEST_TAG:-none}"
          echo "Previous tag: ${PREVIOUS_TAG:-<none>}"

          echo "üßæ Generating release notes..."
          if [ -z "$PREVIOUS_TAG" ]; then
            NOTES="Initial release."
          else
            # Fetch merged PRs between previous tag and current tag
            NOTES=$(gh api repos/${{ github.repository }}/pulls \
              --jq '.[] | select(.merged_at != null) | 
              select(.merge_commit_sha as $sha | 
              inside(["'$(git log --format="%H" ${PREVIOUS_TAG}..$VERSION | tr "\n" "," | sed "s/,$//")'"])) | 
              "* \(.title) by @\(.user.login) in \(.html_url)"' \
              2>/dev/null || echo "")

            if [ -z "$NOTES" ]; then
              NOTES=""
            else
              NOTES="## What's Changed\n${NOTES}"
            fi
          fi

          echo "üßæ Release Notes:"
          echo "$NOTES"

          echo "üöÄ Creating GitHub release..."
          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes "$NOTES" \
            --generate-notes